# Secure VPN tunnel with WireGuard

### VPN

Why we need VPN at all? Even less than year ago (mid 2018) I ignored it, everything what I did at that time was: setup server, open required ports in firewall (if provided), install / update software through SSH. It's just work. But there some few important things why you, probably, should use VPN:

  - Additional security layer. If you have 1 server, it can be easy remember what ports should be opened, which should be closed. But even in this case, you can soon forget what should be done on server if switch to other work for some long period of time. From other side, you can use VPN and worry about opened ports less (but by using VPN I'm not saing that you should not close not required ports, I'm saing that if you will forget to close something, then consequences will be less). More reading: https://hackernoon.com/leaklooker-find-open-databases-in-a-second-9da4249c8472
  - With custom subnets in VPN you can restrict access from / to some services. For example, you can run database on server which not have access to Internet at all, but in same time database will be reachable for application in VPN.
  - Address persistence. Today you have some public IPs in your invetory for Ansible roles. Tomorrow you recreate server and public IP changed. Instead of fixing inventory you can have persistent private IP. It's not only about Ansible. Same story about DNS records which refer to some server in private network.

### Secure tunnel to VPN

There are plenty of solutions for organizing secure tunnel to VPN, most used probably is [OpenVPN](https://openvpn.net/). But problem here is complexity, just check guide from DigitalOcean: https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04 â€” so much steps, keys, certs, configs. In the end, will you be sure that everything was done correct? Also, as I understand, usually certificates generated by admins on server and then provided to users (at least this was way on my previous work). Is this can be cosidered as secure? Never! It's like if somebody will generate SSH keys for you.

In comparison, [WireGuard](https://www.wireguard.com/) is super simple. Two commands for creating keys, one for private key, one for public key. Simple config in less than 10 lines. Yes, WireGuard have lack of some features, but I think it's possible live without it :)

So, below I'll provide commands with comments for creating and setup WireGuard server with few servers as pool (where possible applications can be located). [Terraform](https://www.terraform.io/) and [Ansible](https://www.ansible.com/) files can be found in subdirectories `tf` & `ansible`. In the end we will receive something like this:

![Alt text](https://g.gravizo.com/source/graphviz1?https://raw.githubusercontent.com/fanatid/notes/master/2019-07-28-wireguard-setup-guide/README.md)
<!--
graphviz1
  digraph G {
    node [shape=box];
    rankdir=LR;
    ranksep=1;
    nodesep=1;

    subgraph cluster_vpn {
      label="VPN\n10.0.0.0/8";

      subgraph cluster_vpn_users_subnet {
        label="Users subnet\n10.0.1.0/24";

        subgraph cluster_vpn_user1 {
          label="User1";
          user1 [label="<eth0> eth0\n178.213.13.136|<wg0> wg0\n10.0.1.1",shape=Mrecord];
        }
      }

      subgraph cluster_hetzner_network {
        label="Hetzner Network";
        gateway [label="Network Gateway\n10.0.0.1"];

        subgraph cluster_vpn_vpn_subnet {
          label="WireGuard subnet\n10.0.2.0/24";

          subgraph cluster_vpn_vpn {
            label="WireGuard Server";
            wg [label="<eth0> eth0\n195.201.137.40|<ens10> ens10\n10.0.1.1|<wg0> wg0\n10.0.2.1",shape=Mrecord];
          }
        }

        subgraph cluster_test_subnet {
          label="Test Pool subnet\n10.0.3.0/24";

          subgraph cluster_test_srv1 {
            label="Server1";
            srv1 [label="<eth0> eth0\n116.203.93.123|<ens10> ens10\n10.0.3.1",shape=Mrecord];
          }

          subgraph cluster_test_srv2 {
            label="Server2";
            srv2 [label="<eth0> eth0\n159.69.217.110|<ens10> ens10\n10.0.3.2",shape=Mrecord];
          }
        }
      }
    }

    edge [dir=both];
    user1:wg0 -> wg:wg0;
    wg:ens10 -> gateway;
    srv1:ens10 -> gateway;
    srv2:ens10 -> gateway;
    wg -> srv1 -> srv2 [style=invis]; // better gateway position
  }
graphviz1
-->

We not use `10.0.0.0/24`, because it's look like reserved network by Hetzner (at least gateway for `10.0.0.0/8` on servers in network is `10.0.0.1/32`). Hetzner Network not support firewall through Terraform yet, so we will use iptables for this. Servers from test pool will drop all incoming packets to `eth0` interface (except established TCP connections and ICMP packets). WireGuard server will have same rules as servers from test pool, but allow SSH connections on 22 port and UDP traffic on port 51280 (WireGuard itself). If you sure in your configs, you can also close 22 port on WireGuard server ;)

### Infrastructure

First we need create our infrastructure. In cloud era it's much easier describe and create it with Terraform. Terraform docs for [Hetzner Cloud](https://www.hetzner.com/cloud): https://www.terraform.io/docs/providers/hcloud/index.html

Before you run commands you need change few lines:

  - [tf/variables.tf#L5](tf/variables.tf#L5) -- your Hetzner Cloud token, see how create it here: https://docs.hetzner.cloud/#overview-getting-started
  - [tf/variables.tf#L13](tf/variables.tf#L13) -- SSH key for access to servers

Great, now everything what you need is run 3 commands in [tf](tf) directory:

```bash
terraform init
terraform plan
terraform apply
```

After apply, you should see nearly such output:

```bash
Apply complete! Resources: 10 added, 0 changed, 0 destroyed.

Outputs:

test_pool_ip4 = {
  "116.203.93.123" = "10.0.3.1"
  "159.69.217.110" = "10.0.3.2"
}
wireguard_ip4 = 195.201.137.40 => 10.0.2.1
```

Now you should have 1 Network with 2 Subnets and 3 Servers in your account. Iptables rules will be added in `user-data` scripts: [wireguard.sh](tf/user-data/wireguard.sh), [test.sh](tf/user-data/test.sh) (for cloudinit examples, see https://cloudinit.readthedocs.io/en/latest/topics/examples.html). As you can note, we also install python, it's required for running [Ansible](https://www.ansible.com/) playbooks.

### WireGuard setup

##### Keys generation

Before we continue, you need install WireGuard locally: https://www.wireguard.com/install/

and generate keys, all what you need for this is run from root:

```bash
(export i=wg0; cd /etc/wireguard; wg genkey | tee $i.conf.privatekey | wg pubkey > $i.conf.publickey; chmod 600 $i.conf*)
```

Here we create Private Key with `wg genkey`, write output to file `wg0.conf.privatekey` and send to `wg pubkey` in same time for creating Public Key which will be written to `wg0.conf.publickey`. Also, we need set permission `600` for these files.

When you will create keys, you need fix Public Key in Ansible role `wireguard-config`: [ansible/roles/wireguard-config/vars/example.wg0.yml](ansible/roles/wireguard-config/vars/example.wg0.yml)

##### Server WireGuard Setup

For automated installtion I created 2 small Ansible roles, so everything what you need is run:

```bash
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i 'root@195.201.137.40,' ./wireguard-install.yml ./wireguard-config.yml -e 'target=all wg_host=example wg_name=wg0'
```

do not forget change `195.201.137.40` to IPv4 address which map to `10.0.2.1`.

If you made everything how described here and Hetzner cloud/Terraform/Ansible did not changed anything you can see only 1 error:

```bash
fatal: [root@195.201.137.40]: FAILED! => {"changed": false, "module_stderr": "/bin/sh: 1: /usr/bin/python: not found\n", "module_stdout": "", "msg": "The module failed to execute correctly, you probably need to set the interpreter.\nSee stdout/stderr for the exact error", "rc": 127}
```

this means that `python` still not installed by `user-data` script. Probably you need wait little more before Ansible will able to work.

If everything was fine you should to see something like:

```bash
ok: [root@195.201.137.40] => {
    "msg": "Server WireGuard Public Key: u6ez/wlC3G0R83DM+7pDx44GkkvWeywd0iX///YUCxs="
}
```

If in future you will provide / remove access to users you need adjust users list in [ansible/roles/wireguard-config/vars/example.wg0.yml](ansible/roles/wireguard-config/vars/example.wg0.yml) and use role `wireguard-config` for uploading and applying config.

##### Local WireGuard config

Now you have everything for local WireGuard config, just put it to `/etc/wireguard/wg0.conf` (with permission `600`):

```ini
[Interface]
Address = 10.0.1.1/32
PostUp = wg set %i private-key <(cat /etc/wireguard/%i.conf.privatekey)

[Peer]
PublicKey = u6ez/wlC3G0R83DM+7pDx44GkkvWeywd0iX///YUCxs=
AllowedIPs = 10.0.0.0/8
Endpoint = 195.201.137.40:51820
PersistentKeepalive = 25
```

as you can note, `PublicKey` and `Ednpoint` should be changed to appropriate values.

And now you can start connection with `wg-quick`:

```bash
$ wg-quick up wg0
[#] ip link add wg0 type wireguard
[#] wg setconf wg0 /dev/fd/63
[#] ip -4 address add 10.0.1.1/32 dev wg0
[#] ip link set mtu 1420 up dev wg0
[#] ip -4 route add 10.0.0.0/8 dev wg0
[#] wg set wg0 private-key <(cat /etc/wireguard/wg0.conf.privatekey)
```

if you have same output then `ping 10.0.2.1` should work, as SSH to `10.0.3.1` / `10.0.3.2`.

For startup with system you can activete it with `systemd`: `systemctl enable wg-quick@wg0`.

##### Reverse route

Because subnet for users (`10.0.1.0/24`) is not part of Hetzner Network, we can not send packets from test pool servers (`10.0.3.0/24`) to users (problem is that gateway `10.0.0.1/32` in Hetzner Network do not know anything about our WireGuard users). This can be solved if we define additional route where all packets with destination `10.0.1.0/24` will go to our WireGuard server `10.0.2.1/32`, or in Terraform:

```terraform
resource "hcloud_network_route" "reverse" {
  network_id = "${hcloud_network.default.id}"
  destination = "10.0.1.0/24"
  gateway = "10.0.2.1"
}
```

after this our servers in private network will able start communication with our WireGuard users.

### SSH keys

In addition to WireGuard ansible roles I created 2 roles for simple SSH keys management on servers. Before you run it, you need change key in [ansible/roles/ssh-keys/vars/main.yml](ansible/roles/ssh-keys/vars/main.yml).

  - Role `sshd` upload `sshd_config` which disable password-based authentication.
  - Role `ssh-keys` upload defined keys to `/root/.ssh/authorized_keys`. Be careful, if your key not in list and you run role you will lose access to server!

```bash
ansible-playbook -i ./inventory/hosts.yml ./sshd.yml ./ssh-keys.yml -e 'target=all'
```
